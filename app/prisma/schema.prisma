datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model Account {
  id              String            @id // WS account ID
  type            String            // TFSA, RRSP, FHSA, NON_REG, USD
  nickname        String?
  currency        String            @default("CAD")
  status          String            @default("open")
  netliquidation  Decimal           @db.Decimal(14, 2)
  buyingPower     Decimal           @default(0) @db.Decimal(14, 2)
  totalDeposits   Decimal           @default(0) @db.Decimal(14, 2)
  totalWithdrawals Decimal          @default(0) @db.Decimal(14, 2)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  positions       Position[]
  snapshots       AccountSnapshot[]
  activities      Activity[]
  dividends       Dividend[]
  returnRates     AccountReturnRate[]

  @@map("accounts")
}

model Position {
  id              String   @id @default(cuid())
  accountId       String
  account         Account  @relation(fields: [accountId], references: [id])
  securityId      String?
  security        Security? @relation(fields: [securityId], references: [id])
  symbol          String
  name            String
  quantity        Decimal  @db.Decimal(14, 6)
  bookValue       Decimal  @db.Decimal(14, 2)
  marketValue     Decimal  @db.Decimal(14, 2)
  gainLoss        Decimal  @db.Decimal(14, 2)
  gainLossPct     Decimal  @db.Decimal(12, 4)
  currency        String   @default("CAD")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([accountId, symbol])
  @@map("positions")
}

model AccountSnapshot {
  id              String   @id @default(cuid())
  accountId       String
  account         Account  @relation(fields: [accountId], references: [id])
  date            DateTime @db.Date
  netliquidation  Decimal  @db.Decimal(14, 2)
  deposits        Decimal  @default(0) @db.Decimal(14, 2)
  withdrawals     Decimal  @default(0) @db.Decimal(14, 2)
  earnings        Decimal  @default(0) @db.Decimal(14, 2)
  createdAt       DateTime @default(now())

  @@unique([accountId, date])
  @@map("account_snapshots")
}

model Activity {
  id              String   @id // WS activity ID
  accountId       String
  account         Account  @relation(fields: [accountId], references: [id])
  type            String   // buy, sell, dividend, deposit, withdrawal, fee, etc.
  symbol          String?
  description     String?
  quantity        Decimal? @db.Decimal(14, 6)
  price           Decimal? @db.Decimal(14, 4)
  amount          Decimal  @db.Decimal(14, 2)
  currency        String   @default("CAD")
  occurredAt      DateTime
  createdAt       DateTime @default(now())

  @@index([accountId])
  @@index([type])
  @@index([occurredAt])
  @@map("activities")
}

model Dividend {
  id              String   @id @default(cuid())
  accountId       String
  account         Account  @relation(fields: [accountId], references: [id])
  symbol          String
  amount          Decimal  @db.Decimal(14, 4)
  currency        String   @default("CAD")
  paymentDate     DateTime @db.Date
  frequency       String?  // monthly, quarterly, semi-annual, annual
  createdAt       DateTime @default(now())

  @@unique([accountId, symbol, paymentDate])
  @@index([paymentDate])
  @@map("dividends")
}

model Security {
  id              String     @id // WS security ID or custom
  symbol          String     @unique
  name            String
  type            String?    // etf, stock, mutual_fund
  exchange        String?
  currency        String     @default("CAD")
  dividendYield   Decimal?   @db.Decimal(8, 4)
  mer             Decimal?   @db.Decimal(6, 4)
  peRatio         Decimal?   @db.Decimal(10, 2)
  marketCap       Decimal?   @db.Decimal(18, 2)
  sector          String?
  industry        String?
  country         String?
  assetClass      String?    // Equity, Fixed Income, Cash, Crypto, Real Estate
  fiftyTwoWeekHigh Decimal?  @db.Decimal(14, 4)
  fiftyTwoWeekLow  Decimal?  @db.Decimal(14, 4)
  currentPrice    Decimal?   @db.Decimal(14, 4)
  priceUpdatedAt  DateTime?
  updatedAt       DateTime   @updatedAt
  createdAt       DateTime   @default(now())
  positions       Position[]

  @@map("securities")
}

model QuoteCache {
  symbol    String   @id
  data      Json
  fetchedAt DateTime @default(now())

  @@map("quote_cache")
}

model ContributionRoom {
  id          String   @id @default(cuid())
  accountType String   // TFSA, RRSP, FHSA
  year        Int
  roomAmount  Decimal  @db.Decimal(14, 2)
  usedAmount  Decimal  @default(0) @db.Decimal(14, 2)
  notes       String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@unique([accountType, year])
  @@map("contribution_rooms")
}

model SnaptradeUser {
  id              String   @id @default("default")
  snaptradeUserId String
  userSecret      String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("snaptrade_users")
}

model SyncLog {
  id              String   @id @default(cuid())
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  status          String   @default("running") // running, success, error
  accountsCount   Int      @default(0)
  positionsCount  Int      @default(0)
  activitiesCount Int      @default(0)
  snapshotsCount  Int      @default(0)
  dividendsCount  Int      @default(0)
  error           String?
  createdAt       DateTime @default(now())

  @@map("sync_logs")
}

model TaxSettings {
  id                  String   @id @default("default")
  province            String   @default("QC")
  personalMarginalRate Decimal @default(0.5331) @db.Decimal(6, 4)
  openingCdaBalance   Decimal  @default(0) @db.Decimal(14, 2)
  cdaAsOfDate         DateTime @default(now()) @db.Date
  openingRdtohBalance Decimal  @default(0) @db.Decimal(14, 2)
  rdtohAsOfDate       DateTime @default(now()) @db.Date
  taxYear             Int      @default(2025)
  updatedAt           DateTime @updatedAt
  createdAt           DateTime @default(now())

  @@map("tax_settings")
}

// ─── Phase 1B: Return Rates ──────────────────────────────────────────────────

model AccountReturnRate {
  id        String   @id @default(cuid())
  accountId String
  account   Account  @relation(fields: [accountId], references: [id])
  timeframe String   // ALL, 1Y, 6M, 3M, 1M
  returnPct Decimal  @db.Decimal(10, 4)
  fetchedAt DateTime @default(now())

  @@unique([accountId, timeframe])
  @@map("account_return_rates")
}

// ─── Phase 1D: FX Rate Cache ─────────────────────────────────────────────────

model FXRateCache {
  pair      String   @id // "USD/CAD"
  rate      Decimal  @db.Decimal(10, 6)
  fetchedAt DateTime @default(now())

  @@map("fx_rate_cache")
}

// ─── Phase 2A: Alerts ────────────────────────────────────────────────────────

model Alert {
  id          String    @id @default(cuid())
  type        String    // aaii_threshold, tlh_window, concentration_risk, market_move, rebalance_drift, goal_milestone
  severity    String    @default("info") // info, warning, critical
  title       String
  description String
  actionUrl   String?
  data        Json?
  read        Boolean   @default(false)
  dismissed   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?

  @@index([read, createdAt])
  @@map("alerts")
}

// ─── Phase 3B: Tax Memos ─────────────────────────────────────────────────────

model TaxMemo {
  id          String   @id @default(cuid())
  quarter     String   @unique // "2025-Q1"
  year        Int
  content     String   @db.Text
  data        Json
  generatedAt DateTime @default(now())

  @@map("tax_memos")
}

// ─── Phase 4A: Financial Goals ───────────────────────────────────────────────

model FinancialGoal {
  id                  String   @id @default(cuid())
  name                String
  targetAmount        Decimal  @db.Decimal(14, 2)
  currentAmount       Decimal  @default(0) @db.Decimal(14, 2)
  targetDate          DateTime @db.Date
  accountIds          String[]
  priority            Int      @default(1)
  category            String   // retirement, education, house, emergency, custom
  monthlyContribution Decimal  @default(0) @db.Decimal(14, 2)
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("financial_goals")
}

// ─── Phase 4B: Target Allocations ────────────────────────────────────────────

model TargetAllocation {
  id         String   @id @default(cuid())
  name       String
  assetClass String   @unique
  targetPct  Decimal  @db.Decimal(6, 2)
  minPct     Decimal  @db.Decimal(6, 2)
  maxPct     Decimal  @db.Decimal(6, 2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("target_allocations")
}
